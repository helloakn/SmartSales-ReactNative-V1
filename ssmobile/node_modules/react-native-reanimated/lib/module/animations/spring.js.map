{"version":3,"sources":["spring.js"],"names":["cond","sub","divide","multiply","sqrt","add","block","set","exp","sin","cos","eq","or","neq","and","lessThan","greaterThan","proc","min","abs","AnimatedValue","MAX_STEPS_MS","spring","clock","state","config","lastTime","time","deltaTime","c","damping","m","mass","k","stiffness","v0","velocity","x0","toValue","position","zeta","omega0","omega1","t","sin1","cos1","underDampedEnvelope","underDampedFrag1","underDampedPosition","underDampedVelocity","criticallyDampedEnvelope","criticallyDampedPosition","criticallyDampedVelocity","prevPosition","isOvershooting","overshootClamping","isVelocity","restSpeedThreshold","isDisplacement","restDisplacementThreshold","finished","procSpring"],"mappings":"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","sourcesContent":["import {\n  cond,\n  sub,\n  divide,\n  multiply,\n  sqrt,\n  add,\n  block,\n  set,\n  exp,\n  sin,\n  cos,\n  eq,\n  or,\n  neq,\n  and,\n  lessThan,\n  greaterThan,\n  proc,\n  min,\n  abs,\n} from '../base';\nimport AnimatedValue from '../core/InternalAnimatedValue';\n\nconst MAX_STEPS_MS = 64;\n\nfunction spring(clock, state, config) {\n  const lastTime = cond(state.time, state.time, clock);\n\n  const deltaTime = min(sub(clock, lastTime), MAX_STEPS_MS);\n\n  const c = config.damping;\n  const m = config.mass;\n  const k = config.stiffness;\n\n  const v0 = multiply(-1, state.velocity);\n  const x0 = sub(config.toValue, state.position);\n\n  const zeta = divide(c, multiply(2, sqrt(multiply(k, m)))); // damping ratio\n  const omega0 = sqrt(divide(k, m)); // undamped angular frequency of the oscillator (rad/ms)\n  const omega1 = multiply(omega0, sqrt(sub(1, multiply(zeta, zeta)))); // exponential decay\n\n  const t = divide(deltaTime, 1000); // in seconds\n\n  const sin1 = sin(multiply(omega1, t));\n  const cos1 = cos(multiply(omega1, t));\n\n  // under damped\n  const underDampedEnvelope = exp(multiply(-1, zeta, omega0, t));\n  const underDampedFrag1 = multiply(\n    underDampedEnvelope,\n    add(\n      multiply(sin1, divide(add(v0, multiply(zeta, omega0, x0)), omega1)),\n      multiply(x0, cos1)\n    )\n  );\n  const underDampedPosition = sub(config.toValue, underDampedFrag1);\n  // This looks crazy -- it's actually just the derivative of the oscillation function\n  const underDampedVelocity = sub(\n    multiply(zeta, omega0, underDampedFrag1),\n    multiply(\n      underDampedEnvelope,\n      sub(\n        multiply(cos1, add(v0, multiply(zeta, omega0, x0))),\n        multiply(omega1, x0, sin1)\n      )\n    )\n  );\n\n  // critically damped\n  const criticallyDampedEnvelope = exp(multiply(-1, omega0, t));\n  const criticallyDampedPosition = sub(\n    config.toValue,\n    multiply(\n      criticallyDampedEnvelope,\n      add(x0, multiply(add(v0, multiply(omega0, x0)), t))\n    )\n  );\n  const criticallyDampedVelocity = multiply(\n    criticallyDampedEnvelope,\n    add(\n      multiply(v0, sub(multiply(t, omega0), 1)),\n      multiply(t, x0, omega0, omega0)\n    )\n  );\n\n  // conditions for stopping the spring animations\n  const prevPosition = state.prevPosition\n    ? state.prevPosition\n    : new AnimatedValue(0);\n\n  const isOvershooting = cond(\n    and(config.overshootClamping, neq(config.stiffness, 0)),\n    cond(\n      lessThan(prevPosition, config.toValue),\n      greaterThan(state.position, config.toValue),\n      lessThan(state.position, config.toValue)\n    )\n  );\n  const isVelocity = lessThan(abs(state.velocity), config.restSpeedThreshold);\n  const isDisplacement = or(\n    eq(config.stiffness, 0),\n    lessThan(\n      abs(sub(config.toValue, state.position)),\n      config.restDisplacementThreshold\n    )\n  );\n\n  return block([\n    set(prevPosition, state.position),\n    cond(\n      lessThan(zeta, 1),\n      [\n        set(state.position, underDampedPosition),\n        set(state.velocity, underDampedVelocity),\n      ],\n      [\n        set(state.position, criticallyDampedPosition),\n        set(state.velocity, criticallyDampedVelocity),\n      ]\n    ),\n    set(state.time, clock),\n    cond(or(isOvershooting, and(isVelocity, isDisplacement)), [\n      cond(neq(config.stiffness, 0), [\n        set(state.velocity, 0),\n        set(state.position, config.toValue),\n      ]),\n      set(state.finished, 1),\n    ]),\n  ]);\n}\n\nconst procSpring = proc(\n  (\n    finished,\n    velocity,\n    position,\n    time,\n    prevPosition,\n    toValue,\n    damping,\n    mass,\n    stiffness,\n    overshootClamping,\n    restSpeedThreshold,\n    restDisplacementThreshold,\n    clock\n  ) =>\n    spring(\n      clock,\n      {\n        finished,\n        velocity,\n        position,\n        time,\n        // @ts-ignore\n        prevPosition,\n      },\n      {\n        toValue,\n        damping,\n        mass,\n        stiffness,\n        overshootClamping,\n        restDisplacementThreshold,\n        restSpeedThreshold,\n      }\n    )\n);\n\nexport default (\n  clock,\n  {\n    finished,\n    velocity,\n    position,\n    time,\n    // @ts-ignore\n    prevPosition,\n  },\n  {\n    toValue,\n    damping,\n    mass,\n    stiffness,\n    overshootClamping,\n    restDisplacementThreshold,\n    restSpeedThreshold,\n  }\n) =>\n  procSpring(\n    finished,\n    velocity,\n    position,\n    time,\n    prevPosition,\n    toValue,\n    damping,\n    mass,\n    stiffness,\n    overshootClamping,\n    restSpeedThreshold,\n    restDisplacementThreshold,\n    clock\n  );\n"]}